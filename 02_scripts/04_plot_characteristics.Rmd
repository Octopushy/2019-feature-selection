---
title: "04-plot characteristics"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
---

# Load packages

```{r, results='hide'}
devtools::install_github("mlr-org/mlr@blocking")

library(dplyr)
library(tibble)
library(purrr)
library(magrittr)
library(data.table)
library(raster)
library(ggplot2)
library(hrbrthemes)
library(cowplot)
library(here)
library(ggpubr)
library(ggsci)
library(ggrepel)
```

# Read data

Variables per plot:

Lauki1: 7594
Laukiz2: 7594
Oiartzun: 7841
Luiando: 7471

Why is there such a huge difference in the number of indices without NAs for the plots?

```{r}
data <- readRDS("/data/patrick/mod/hyperspectral/data_clean_with_indices/data_clean_standardized_bf2.rda")
coords <- readRDS("/data/patrick/mod/hyperspectral/data_clean_with_indices/data_clean_standardized_bf2-coords.rda")
```

# Merge into one dataset

Leaving out Luiando (see README for reason).

```{r}
data <- as_tibble(rbindlist(data, fill = TRUE)) # combine all plots
data <- Filter(function(x) !any(is.na(x)), data) # filter out columsn containing NA
coords <- as_tibble(rbindlist(coords))
data %<>%
  mutate(plot = factor(rep(c("Laukiz 1", "Laukiz 2", "Luiando", "Oiartzun"), 
                           c(479, 451, 291, 529))))
```

# Mean defoliation per plot

```{r}
mean_defol = data %>%
  group_by(plot) %>%
  summarise(mean(defoliation)) %>% 
  pull(.)

data %>%
  group_by(plot) %>%
  summarise(mean(defoliation))
```

# Coefficient of variation

```{r}
cov_defol = data %>%
  group_by(plot) %>%
  summarise((sd(defoliation) / mean(defoliation)) * 100) %>% 
  pull(.)

data %>%
  group_by(plot) %>%
  summarise((sd(defoliation) / mean(defoliation)) * 100)
```

#  sd / skewness

```{r}
sd_skewness_defol = data %>%
  group_by(plot) %>%
  summarise(((sd(defoliation) / mean(defoliation)) * 100) / e1071::skewness(defoliation)) %>% pull(.)

data %>%
  group_by(plot) %>%
  summarise(((sd(defoliation) / mean(defoliation)) * 100) / e1071::skewness(defoliation))
```

```{r}
sd_defol = data %>%
  group_by(plot) %>%
  summarise(sd(defoliation)) %>% 
  pull(.)

data %>%
  group_by(plot) %>%
  summarise(sd(defoliation))
```

```{r}
boxplot_defol = data %>%
  group_by(plot) %>%
  ggboxplot(
    x = "plot", y = "defoliation", color = "plot",
    add = "jitter", add.params = list(size = "defoliation")
  ) +
  scale_size(range = c(0.5, 0.5)) +
  annotate("text",
    label = expression(bold(atop("n = 479", bar(x)~"= 55.96"))), x = 1, 
    y = 112, size = 3, colour = "#BC3C29", fontface = 2
  ) +
  annotate("text",
    label = expression(bold(atop("n = 451", bar(x)~"= 13.54"))), x = 2, 
    y = 112, size = 3, colour = "#0072B5", fontface = 2
  ) +
  annotate("text",
    label = expression(bold(atop("n = 291", bar(x)~"= 68.44"))), x = 3, 
    y = 112, size = 3, colour = "#E18727", fontface = 2
  ) +
  annotate("text",
    label = expression(bold(atop("n = 529", bar(x)~"= 69.22"))), x = 4, 
    y = 112, size = 3, colour = "#20854E", fontface = 2
  ) +
  scale_color_nejm() +
  theme(legend.position = "none") +
  labs(y = "Total defoliation per tree (%)", x = "Plot")
boxplot_defol
```

```{r}
save_plot(here("03_figures/results/boxplot_defol.png"), boxplot_defol)
```

# Point density

In Meters.

```{r}
plots <- list("Laukiz 1", "Laukiz 2", "Luiando", "Oiartzun")

dist <- map(plots, ~ {
  coords <- coords %>%
    mutate(plot = factor(rep(c("Laukiz 1", "Laukiz 2", "Luiando", "Oiartzun"), 
                             c(479, 451, 291, 529)))) %>%
    filter(plot == .x) %>%
    dplyr::select(-plot)

  points <- SpatialPoints(coords = coords, 
                          proj4string = CRS("+proj=utm +zone=30 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))

  distance <- mean(as.dist(pointDistance(points, allpairs = TRUE, lonlat = FALSE)))
})
set_names(dist, plots)

dist_plots = unlist(dist)
```

# Scatterplots

Visualize RMSE vs plot characteristics

## Load CV results

```{r}
laukiz1 = readRDS("/data/patrick/mod/hyperspectral/spcv/laukiz1_xgboost.rda")
laukiz2 = readRDS("/data/patrick/mod/hyperspectral/spcv/laukiz2_xgboost.rda")
luiando = readRDS("/data/patrick/mod/hyperspectral/spcv/luiando_xgboost.rda")
oiartzun = readRDS("/data/patrick/mod/hyperspectral/spcv/oiartzun_xgboost.rda")

models <- list(laukiz1, laukiz2, luiando, oiartzun)

results_reps <- map(models, ~ .x$measures.test %>% 
                      dplyr::mutate(rep = rep(1:5, times = 1, each = 5)) %>% 
                      group_by(rep) %>% 
                      summarise_at("rmse", mean),
)
results_reps <- set_names(results_reps, 
                          c("laukiz1", "laukiz2", "luiando", "oiartzun"))
```


```{r}
df <- tibble(
  plot = factor(c("Laukiz 1", "Laukiz 2", "Luiando", "Oiartzun")),
  rmse = c(mean(results_reps$laukiz1), mean(results_reps$laukiz2), mean(results_reps$luiando), mean(results_reps$oiartzun)),
  point_dens = dist_plots,
  mean_defol = mean_defol,
  cov_defol = cov_defol,
  sd_skewness = sd_skewness_defol
)
```

## RMSE vs point dens

```{r}
rmse_dens <- ggplot(df, aes(x = point_dens, y = rmse)) +
  geom_point(aes(color = plot), shape = 19, size = 3) +
  labs(x = "Mean point density (m)", y = "RMSE") +
  theme_ipsum_rc(
    axis_title_size = 22,
    axis_title_just = "c"
  ) +
  scale_color_nejm() +
  theme(
    plot.margin = unit(c(6, 0, 6, 0), "pt"),
    legend.position = "none",
    axis.text = element_text(size = 20),
    legend.text = element_text(size = 20),
    axis.title.y = element_text(margin = margin(
      t = 0, r = 15,
      b = 0, l = 0
    )),
    axis.title.x = element_text(margin = margin(
      t = 15, r = 0,
      b = 0, l = 0
    ))
  )
```

## RMSE vs coef of variation / skewness

```{r}
rmse_defol_cov_sk <- ggplot(df, aes(x = sd_skewness, y = rmse)) +
  geom_point(aes(color = plot), shape = 19, size = 3) +
  labs(x = "CV (%) / Skewness", y = "") +
  theme_ipsum_rc(
    axis_title_size = 22,
    axis_title_just = "c"
  ) +
  scale_color_nejm() +
  theme(
    plot.margin = unit(c(6, 0, 6, 0), "pt"),
    legend.position = "none",
    axis.text = element_text(size = 20),
    legend.text = element_text(size = 20),
    axis.title.y = element_text(margin = margin(
      t = 0, r = 15,
      b = 0, l = 0
    )),
    axis.title.x = element_text(margin = margin(
      t = 15, r = 0,
      b = 0, l = 0
    ))
  )
```

## RMSE vs coef of variation

```{r}
rmse_defol_cov <- ggplot(df, aes(x = cov_defol, y = rmse)) +
  geom_point(aes(color = plot), shape = 19, size = 3) +
  labs(x = "CV (%)", y = "") +
  theme_ipsum_rc(
    axis_title_size = 22,
    axis_title_just = "c"
  ) +
  scale_color_nejm() +
  theme(
    plot.margin = unit(c(6, 0, 6, 0), "pt"),
    legend.position = "none",
    axis.text = element_text(size = 20),
    legend.text = element_text(size = 20),
    axis.title.y = element_text(margin = margin(
      t = 0, r = 15,
      b = 0, l = 0
    )),
    axis.title.x = element_text(margin = margin(
      t = 15, r = 0,
      b = 0, l = 0
    ))
  )
```

## Plot

### Legend

```{r}
legend <- ggplot(df, aes(x = mean_defol, y = rmse)) +
  geom_point(aes(color = plot), shape = 19, size = 3) +
  labs(x = "Mean defoliation (%)", y = "RMSE", color = "Plot") +
  theme_ipsum_rc(
    axis_title_size = 16,
    axis_title_just = "c"
  ) +
  scale_color_nejm() +
  theme(
    axis.text = element_text(size = 20),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 20),
    axis.title.y = element_text(margin = margin(
      t = 0, r = 15,
      b = 0, l = 0
    ))
  )
legend <- get_legend(legend)
```

### Grid

```{r}
prow = plot_grid(rmse_dens, rmse_defol_cov, rmse_defol_cov_sk,  align = 'vh', nrow = 1)
plots_grid <- plot_grid(prow, legend, rel_widths = c(3, .3))
```

```{r}
plots_grid <- plot_grid(rmse_dens, legend, rmse_defol, ncol = 3, rel_widths = c(1, .3, 1))
```

```{r}
save_plot(here("03_figures/results/plot-characteristics.png"), plots_grid, ncol = 4)
```

# PNG to PDF conversion

Converts all pngs in the specified folder to pdfs. 
`&&` makes the "convert" call conditional on `cd`.
`exec` reduces memory waste of shell.
Uses "GNU parallel" library for parallel jobs and the `convert` function from the `ImageMagick` library.

```{r png to pdf, echo = FALSE, eval = FALSE}
# system("cd /home/patrick/PhD/papers/03_hyperspectral/03_figures/data && exec ls -1 *.png |
#        parallel convert '{}' '{.}.pdf'")

system("cd /home/patrick/PhD/papers/03_hyperspectral/03_figures/results/ && exec ls -1 *.png | 
       parallel convert '{}' '{.}.pdf'")

# copy to presentation folder
# file_copy("/home/patrick/PhD/papers/01_model_comparison/04_figures/02_results/cv_boxplots_final.png",
#           "/home/patrick/PhD/presentations/paper1/figs/cv_boxplots_final.png",
#           overwrite = TRUE)
```

# Session Info

```{r}
sessionInfo()
```

