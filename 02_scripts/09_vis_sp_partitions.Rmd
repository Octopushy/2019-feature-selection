---
title: "03-study area"
output:
  html_notebook:
    code_folding: none
    fig_width: 10
    highlight: haddock
    number_sections: yes
    toc: yes
---

# Packages

```{r}
devtools::install_github("mlr-org/mlr@fix-create-resamp-plots")
library(mlr)
library(tibble)
library(data.table)
library(cowplot)
library(ggrepel)
library(magrittr)
```

# Visualize partitions

Here we visualize the partitioning of the first repetition (5 folds) in the performance estimation level of the spatial and non-spatial cross-validation setting.

## Blocking

```{r fig.height=3, fig.width=13}
data = readRDS("/data/patrick/mod/hyperspectral/data_clean_with_indices/data_clean_standardized_bf2.rda")
coords = readRDS("/data/patrick/mod/hyperspectral/data_clean_with_indices/data_clean_standardized_bf2-coords.rda")


data = as_tibble(rbindlist(data, fill = TRUE))
data = Filter(function(x) !any(is.na(x)), data)
coords = as_tibble(rbindlist(coords))
data$plot = factor(rep(c("Laukiz 1", "Laukiz 2", "Luiando", "Oiartzun"), c(479, 451, 291, 529)))
data = cbind(data, coords)

data %<>% 
  #dplyr::slice(c(200, 700, 1100, 1400)) %>% 
  dplyr::select(defoliation, plot, X, Y)

#rownames(data) = c("200", "700", "1100", "1400")

task = makeRegrTask(id = "all_plots", data = data, 
                    target = "defoliation", coordinates = data[, c("X", "Y")])

resamp_blocking <- readRDS("/data/patrick/mod/hyperspectral/spcv/all_plots_svm_blocking.rda")

plist <- createSpatialResamplingPlots(task, list("Block CV" = resamp_blocking),
                                      crs = 32630, repetitions = 1, point.size = 1.5,
                                      y.axis.breaks = c(43.35, 43.1), 
                                      x.axis.breaks = c(-2.8, -2),
                                      axis.text.size = 18)

# We need to subset the data with geom_label_repel to only plot 4 repels
# We need to make sure to select one instance of every plot
plist[["Plots"]] = purrr::map(plist[["Plots"]], ~ .x + 
                         geom_label_repel(aes(x = X, y = Y, label = plot), 
                                          min.segment.length = unit(1, "lines"),
                                          data = subset(.x$data, rownames(.x$data) %in% 
                                                          c(200, 700, 1100, 1400))) +
                           labs(y = "", x = "") +
                           #theme(plot.margin = unit(c(0, 0, 0, 0), "cm")) +
                           #hrbrthemes::theme_ipsum_rc(plot_margin = margin(0, 0, 0, 0))
                       )


plots = plot_grid(plotlist = plist[["Plots"]], labels = plist[["Labels"]],
                  nrow = 2, ncol = 2)

plots = patchwork::wrap_plots(plist[["Plots"]])


save_plot("../03_figures/data/blocking_folds.png", 
          plots, ncol = 2, nrow = 2)
```

## sp sp


```{r}
data = readRDS("/data/patrick/mod/hyperspectral/data_clean_with_indices/data_clean_standardized_bf2.rda")
coords = readRDS("/data/patrick/mod/hyperspectral/data_clean_with_indices/data_clean_standardized_bf2-coords.rda")

data = data[[4]]
coords = coords[[4]]

data %<>% 
  dplyr::select(defoliation)

task = makeRegrTask(id = "oiartzun", data = data, 
                    target = "defoliation", coordinates = coords)

resamp_sp <- readRDS("/data/patrick/mod/hyperspectral/spcv/luiando_xgboost.rda")

plist <- createSpatialResamplingPlots(task, list("SpCV" = resamp_sp),
                                      crs = 32630, repetitions = 1, point.size = 1.5,
                                      #y.axis.breaks = c(42.8, 43.2), 
                                      #x.axis.breaks = c(-2, -3),
                                      axis.text.size = 18)

plot_grid(plot)
```



# for presentation

```{r}
sp_pres <- plot_grid(plist[["Plots"]][[1]], plist[["Plots"]][[2]], plist[["Plots"]][[3]], 
                plist[["Plots"]][[4]], plist[["Plots"]][[5]], ncol = 5, nrow = 1, 
                labels = plist[["Labels"]][1:5], label_size = 18)

nsp_pres <- plot_grid(plist[["Plots"]][[6]], plist[["Plots"]][[7]], plist[["Plots"]][[8]], 
                 plist[["Plots"]][[9]], plist[["Plots"]][[10]],
                 ncol = 5, nrow = 1, labels = plist[["Labels"]][6:10],
                 label_size = 18)

final_plot_pres <- plot_grid(sp_pres, nsp_pres, ncol = 1)

save_plot("../04_figures/01_data/spcv_nspcv_folds_pres.png", 
          final_plot_pres, ncol = 5, nrow = 2)
```

# PNG to PDF conversion

Converts all pngs in the specified folder to pdfs. 
`&&` makes the "convert" call conditional on `cd`.
`exec` reduces memory waste of shell.
Uses "GNU parallel" library for parallel jobs and the `convert` function from the `ImageMagick` library.

```{r png to pdf, echo = FALSE, eval = FALSE}
library(furrr)
library(magick)
imgs = list.files("/home/patrick/PhD/papers/01_model_comparison/04_figures/01_data", 
                  pattern = ".png", full.names = TRUE)

plan(multiprocess, workers = length(imgs))
future_walk(imgs, ~ image_write(image_read(.x), 
                                path = stringr::str_replace(.x, ".png", ".pdf"), 
                                format = "pdf"))

system("cd /home/patrick/PhD/papers/01_model_comparison/04_figures/01_data && exec ls -1 *.png | 
       parallel convert '{}' '{.}.pdf'")

system("cd /home/patrick/PhD/papers/01_model_comparison/04_figures/02_results/ && exec ls -1 *.png | 
       parallel convert '{}' '{.}.pdf'")

system("cp /home/patrick/PhD/papers/01_model_comparison/04_figures/01_data/study_area.png /home/patrick/PhD/presentations/paper1/figs/study_area.png")
system("cp /home/patrick/PhD/papers/01_model_comparison/04_figures/01_data/spcv_nspcv_folds_pres.png /home/patrick/PhD/presentations/paper1/figs/spcv_nspcv_folds_pres.png")
```
