---
title: "NDVI analysis of hyperspectral data"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

# Load packages

```{r}
library(purrr)
library(magrittr)
library(pbmcapply)
library(raster)
library(rasterVis)
library(viridis)
library(gridExtra)
library(tools)
library(stringr)
library(tibble)
library(dplyr)
library(ggplot2)
```

# NDVI analysis

Note: Names of raster objects will always have a dot in it which cannot be replaced by a dash or a whitespace.

That is the reason why we set the names in `levelplot_mod()`.

```{r}
ndvi_data <- list.files("/data/patrick/mod/hyperspectral/ndvi",
  pattern = "ndvi2.*\\.tif", full.names = TRUE
) %>%
  map(~ raster(.x)) %>%
  map(~ projectRaster(.x, crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")) %>%
  map(~ set_names(.x, gsub(".", " ", str_sub(names(.x), 7), fixed = T)))

names_ndvi_data <- map_chr(ndvi_data, names) %>%
  map_chr(~ str_replace_all(.x, "\\.", " ")) %>%
  map_chr(toTitleCase)
```

```{r}
levelplot_mod <- function(x, names_raster) {
  levelplot(
    x,
    main = names_raster,
    margin = FALSE,
    pretty = TRUE, 
    colorkey = list(
      width = 0.75, 
      space = "right",
      labels = list(
        at = seq(-1, 1,
          by = 0.2
        ),
        font = 4
      ), 
      axis.line = list(col = "black")
    ),
    par.strip.text = list(col = "white", cex = 1.2),
    par.settings = list(
      axis.line = list(col = "transparent"), 
      strip.background = list(col = "black")
    ),
    col.regions = viridis,
    at = seq(-1, 1, len = 101)
  )
}
```

```{r}
ndvi_plots <- map2(ndvi_data, names_ndvi_data, ~ levelplot_mod(.x, .y))
```

## Plot 1-9

```{r}
grid.arrange(grobs = ndvi_plots[c(1:9)], ncol = 3)
```

## Plot 10-19

```{r}
grid.arrange(grobs = ndvi_plots[c(10:19)], ncol = 3)
```

## Plot 20:28

```{r}
grid.arrange(grobs = ndvi_plots[c(20:28)], ncol = 3)
```

## Plot demonstration plots

```{r}
grid.arrange(grobs = ndvi_plots[c(15, 16, 18, 19)], ncol = 2)
```

## Plot NDVI histograms

Note: Hernani is missing as we have no hyperspectral coverage for that plot.

```{r}
plot_values_comb <- map(ndvi_data, ~ as_tibble(.x@data@values)) %>%
  map2(names_ndvi_data, ~ mutate(.x, Name = .y)) %>%
  map(na.omit) %>%
  reduce(full_join, by = c("value", "Name"))

plot_values_comb %<>%
  mutate(Name = as.factor(Name))

colnames(plot_values_comb) <- c("NDVI", "name")
```

Normalize y-axis of each facet: http://stackoverflow.com/questions/16339204/normalizing-faceted-histograms-separately-in-ggplot2

```{r}
ndvi_histograms <- ggplot(plot_values_comb, aes(x = NDVI)) +
  geom_histogram(aes(y = (..count..) / tapply(..count.., ..PANEL.., sum)[..PANEL..])) +
  facet_wrap(~ name) +
  ylab("Percentage pixel count") +
  xlab("NDVI (-1 to 1)") +
  scale_x_continuous(limits = c(-1, 1)) +
  hrbrthemes::theme_ipsum_rc()
```

## Count pixels per plot (size 1m^2)

```{r}
plot_values_comb %>%
  group_by(name) %>%
  count() %>%
  arrange(desc(n))
```

## Quantiles 

Biased towards low values (non-forest pixels)

```{r}
quantile(plot_values_comb$NDVI)
```

```{r}
boxplot(plot_values_comb$NDVI)
```



