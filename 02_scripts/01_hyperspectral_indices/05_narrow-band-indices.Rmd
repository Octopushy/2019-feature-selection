---
title: "Calculate all possible narrow band indices"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

This script uses the function `nbi_raster()` which is a custom function and only available from the developtment version of `hsdar` on Github: `devtools::install_github("pat-s/hsdar")`.

```{r, results='hide'}
library(raster)
devtools::install_github("pat-s/hsdar")
library(hsdar)
library(pbmcapply)
library(glue)
library(magrittr)
library(purrr)
library(stringr)
```

# Specify wavelength 

```{r}
wavelength = readRDS("/data/patrick/mod/hyperspectral/wavelength.Rds")
```

# Read rasters (cropped by plot) 

## list files

```{r}
list.files("/data/patrick/mod/hyperspectral/atm-cropped", 
                    pattern = ".tif$", full.names = TRUE) %>% 
  map(~ brick(.x)) -> spectral_data
```

# Coerce to class "HyperSpecRaster"

```{r}
hyperspecs = map(spectral_data, function(x) HyperSpecRaster(x, wavelength))
```

# Create narrow band indices

Band names will be calculated automatically by function `nbi_raster`

Takes 190 GB RAM on server when being parallalized.

Runtime per plot between 5 - 27 minutes.

Largest file: 24 GB

```{r, cache=FALSE}
tmp <- pbmclapply(hyperspecs, function(x)  
  nbi_raster(x,
             filename = str_replace(glue("/data/patrick/mod/hyperspectral/",
                             "narrow-band-indices/narrow-band-indices-{name}",
                             name = basename(x@file@name)), ".tif", ".grd"),
             bnames_prefix = "NRI"), mc.cores = 15)
rm(tmp)
```

```{r}
sessionInfo()
```
