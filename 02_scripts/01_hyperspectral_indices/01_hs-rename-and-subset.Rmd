---
title: "R Notebook"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

# Load packages

```{r, results='hide'}
library(sf)
library(raster)
library(magrittr)
library(purrr)
library(dplyr)
```

# Read all atmoshperic corrected hyperspectral images

```{r}
map(list.data_atm("/data/patrick/raw/hyperspectral/ATM", 
                    full.names = TRUE, pattern = ".tif$"),
    ~ brick(.x)) -> data_atm
```

# Read plot locations

```{r}
st_read("/data/patrick/mod/plots/location/plot_locations.shp") %>% 
  mutate(Name = as.character(Name)) -> plot_locations
```

# Load plots by name and perform renaming and subsetting for each

Names are extracted from the first three digits in the file name
e.g. B101 -> Plot 'Busturi- axpe' (see README for LUT)

1. Change plot shp CRS to HS CRS (faster than changing the CRS of large raster)
2. Crop HS by plot shp
3. Apply UTM Zone 30 CRS
4. Save cropped raster

```{r}
process_hyperspec <- function(name_id, name_out, index) {
  
  image <- data_atm[[index]]
  
  plot_locations %>% 
    filter(Name == name_id) %>% 
    st_transform(25830) %>% 
    as("Spatial") -> shape_single_plot
  
  image %>% 
    crop(shape_single_plot) %>% 
    mask(shape_single_plot) %>% 
    projectRaster(crs = "+proj=utm +zone=30 +datum=WGS84 +units=m +no_defs") %>% 
    writeRaster(glue("/data/patrick/mod/hyperspectral/atm-cropped/{name_out}.tif"),
                overwrite = TRUE)
  cat(glue("Finished {name_out}."))
}
```

# Create dictionaries to apply over

```{r}
name_id = c("a busturi-axpe", "Laukiz I", "Laukiz II", "Laukiz III", "a altube", 
            "a barazar", "Laricio defol. Urkiola.", "aguinaga pinaster radiata",
            "Oiartzun", "Pinast. Arza", "Pinas. Santa Koloma", "Rad. Menagaray 1",
            "Rad. Menagaray 2", "Ayala/Aiara", "Silvest. Nograro", "a caranca",
            "Picea Abornicano", "douglas 1", "douglas 2", "Rad. Altube", 
            "a otxandio", "Laricio defol. Olaeta. pol", "Douglas Legutio", 
            "Laricio defol.Gatzaga", "a azaceta", "a gipuzkoa", 
            "Sequoia Legorreta", "Douglas Albiztur")
name_out = c("busturi", "laukiz1", "laukiz2", "laukiz3", "altube", "barazar", 
             "laricio-defol-urkiola", "aguinaga-pinaster-radiata", "oiartzun",
             "pinast-arza", "pinas-santa-koloma", "rad-menagaray-1",
             "rad-menagaray-2", "luiando", "silvest-nograro", "caranca",
             "picea-abornicano", "douglas-1", "douglas-2", "rad-altube",
             "otxandio", "laricio-defol-olaeta", "douglas-legutio",
             "laricio-gatzaga", "azaceta", "gipuzkoa", "sequoia-legorreta", 
             "douglas-albiztur")
index = c(1, 2, 2, 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 11, 12, 13, 14, 16, 16, 16,
          17, 17, 18, 20, 21, 22, 22, 23)
```

Now let's map over all entries in the vectors specified.

```{r}
pwalk(list(name_id, name_out, index), ~ process_hyperspec(..1, ..2, ..3))
```

```{r}
sessionInfo()
```

