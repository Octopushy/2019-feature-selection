---
title: "Calculate all possible vegetation indices that the `hsdar` package offers."
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Information about this script

This script accounts for either local (laptop) or server (MCCOY) runs. Path is adjusted using object `prefix`

Since this is an `.Rmd` file it cannot simply be called using `source()` or `Rscript` (server). 

Instead, please use the [custom function `runAllChunks()`](http://stackoverflow.com/a/24754637/4185785) inside an R console with the `.Rmd` file as input. 
It is recommended to put this function into your .Rprofile to have it available whenever you start an R session.

```{r}
pacman::p_load(raster, hsdar, pbapply, parallel, rasterFunctions, tidyverse)
```

# Specify wavelength

```{r}
wavelength <- readRDS("/home/shares/data/LIFE/mod/hyperspectral/wavelength.Rds")
```

# List files

```{r}
files <- list.files("/home/shares/data/LIFE/mod/hyperspectral/atm-cropped", 
                    pattern = ".tif$", full.names = TRUE)
```

# read in files as "RasterBrick"
```{r}
spectral_data <- lapply(files, function(x) brick(x))
```

# make class "HyperSpecRaster"

```{r}
hyperspecs <- lapply(spectral_data, function(x) hsdar::HyperSpecRaster(x, wavelength))
```

# account for use on local laptop or server
```{r}
if (detectCores() > 10) {
  cores <- 28
} else (cores <- 1)
```

# do calculation 

Runtime server: ~ 1 min
Runtime MBP: ~ 10 mins

Writing files as `.gri` files because this format preserves layer names. TIFF format does not!!
Layer names are changed using the `bnames` argument of function `rasterFunctions::hsdar.vegIndex()`.

Specify vegetation indices. 

```{r}
# subset for test purposes
# hyperspecs <- list(hyperspecs[[17]])


# specify which indices to calculate WITH DERIVATION INDICES
indices <- c("Boochs", "Boochs2","CARI", "Carter", "Carter2", "Carter3", "Carter4", "Carter5",
             "Carter6", "CI", "CI2", "ClAInt", "CRI1", "CRI2", "CRI3", "CRI4",
             "D1", "D2",
             "Datt", "Datt2", "Datt3", "Datt4", "Datt5", "Datt6", "DD", "DDn", "DPI", "DWSI4",
             "EGFR", "EVI", "GDVI_2", "GDVI_3", "GDVI_4", "GI", "Gitelson",
             "Gitelson2", "GMI1", "GMI2", "Green NDVI", "Maccioni", "MCARI",
             "MCARI2", "mND705", "mNDVI", "MPRI", "MSAVI", "mSR",
             "mSR2", "mSR705", "MTCI", "MTVI", "NDVI", "NDVI2", "NDVI3",
             "NPCI", "OSAVI", "PARS", "PRI", "PRI_norm", "PRI*CI2", "PSRI",
             "PSSR", "PSND","SPVI", "PWI", "RDVI", "REP_Li", "SAVI", "SIPI",
             "SPVI","SR", "SR1", "SR2", "SR3", "SR4", "SR5", "SR6", "SR7",
             "SR8", "Sum_Dr1", "Sum_Dr2", "SRPI", "TCARI", "TCARI2", "TGI", "TVI", "Vogelmann",
             "Vogelmann2", "Vogelmann3", "Vogelmann4")
# length(indices)
```

# do veg. indices calculation

```{r }
hyperspecs %>% 
  pblapply(function(x) 
    vegindex(x, indices, filename = 
             gsub(".tif", ".grd", 
                  "/home/shares/data/LIFE/mod/hyperspectral/all-veg-indices/",
                    "all-veg-indices-", basename(x@file@name)), na.rm = T,
             bnames = indices), cl = cores) -> rasters

# mapview(tmp[[1]])
```


